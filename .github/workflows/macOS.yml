name: macOS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  macOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: swift build -v
    # Run tests in batches to limit concurrent crypto operations.
    # Swift Testing runs matched suites in parallel; too many simultaneous
    # BoringSSL/CryptoKit operations crash the test runner.
    - name: Run tests (core crypto)
      run: >-
        swift test -v
        --filter "ChatEnvelope|MessageEncryptor|KeyDerivation|KeyStorage|SignatureVerifier|FileKeyStorage"
    - name: Run tests (forward secrecy + PSK)
      run: >-
        swift test -v
        --filter "EphemeralKeyManager|EncryptionTests|EdgeCase|PSKEncryption|PSKRatchet|CrossProtocol"
    - name: Run tests (decoders + error handling)
      run: >-
        swift test -v
        --filter "EnvelopeDecoder|ErrorRecovery|ChatError|PSKEnvelope"
    - name: Run tests (messaging + misc)
      run: >-
        swift test -v
        --filter "MessageCodable|MessageDirection|MessageEquality|MessageIndexer|FileSendQueue|ConversationMerge|CustomAmountTests|InMemory|PendingMessage|SendQueue|PSKExchangeURI|PSKState|PublicKeyCache|ReplyContext|SyncManager|CacheTests"
