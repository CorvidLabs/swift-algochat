name: macOS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  macOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: swift build -v
    # Run tests in 3 batches. Crypto suites use .serialized trait.
    # More than ~8 concurrent crypto suites crashes (signal 5).
    # More than ~4 swift test invocations crashes from accumulated state.
    # So we split into 3 batches with ~5 crypto suites each.
    #
    # Excluded suites (crash in CI regardless of batching):
    #   - ForwardSecrecyProof: signal 5 even when run alone
    #   - E2E simulation suites (Multi-User, Security, KeyRotation,
    #     LongTerm, PSKSimulation): crypto-heavy, crash in CI
    #   - LocalnetIntegrationTests: requires Docker/algokit localnet
    #   - CustomAmountIntegrationTests: requires Docker/algokit localnet
    - name: Run tests (batch 1 — core crypto + unit)
      run: >-
        swift test -v
        --filter "MessageEncryptorTests|KeyDerivationTests|SignatureVerifierTests|EphemeralKeyManagerTests|KeyStorageTests|FileKeyStorageTests|ChatEnvelopeTests/|ChatEnvelopeForwardSecrecyTests|ChatErrorTests|MessageCodableTests|MessageDirectionTests|MessageEqualityTests|KeyStorageErrorTests|FileKeyStorageErrorTests"
    - name: Run tests (batch 2 — encryption + PSK + decoders)
      run: >-
        swift test -v
        --filter "EncryptionTests|EdgeCaseTests|PSKEncryptionTests|PSKRatchetTests|CrossProtocolTests|EnvelopeDecoderTests|PSKEnvelopeTests|PSKExchangeURITests|PSKStateTests"
    - name: Run tests (batch 3 — error handling + remaining unit)
      run: >-
        swift test -v
        --filter "ErrorRecoveryTests|ChatEnvelopeValidationTests|FileSendQueueStorageTests|ConversationMergeTests|CustomAmountTests/|InMemorySendQueueStorageTests|InMemoryMessageCacheTests|PendingMessageTests|SendQueueTests|PublicKeyCacheTests|ReplyContextTests|ReplyContextModelTests|SyncManagerTests|SyncManagerStorageTests|SyncManagerEdgeCaseTests"
