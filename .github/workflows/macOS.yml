name: macOS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  macOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: swift build -v
    # Run tests in 2 batches. Limit ~12 suites per batch — too many
    # concurrent suites crash CryptoKit/BoringSSL (signal 5).
    # Max 2 swift test invocations (3rd+ crashes on startup).
    #
    # Excluded suites (crash in CI regardless of batching):
    #   - ForwardSecrecyProof: signal 5 even when run alone
    #   - EncryptionTests, EdgeCaseTests, PSKEncryptionTests,
    #     CrossProtocolTests, ReplyContextTests: heavy crypto
    #   - E2E simulation suites: crypto-heavy, crash in CI
    #   - LocalnetIntegrationTests: requires Docker/algokit localnet
    #   - CustomAmountIntegrationTests: requires Docker/algokit localnet
    - name: Run tests (batch 1 — crypto + envelope)
      run: >-
        swift test -v
        --filter "ChatEnvelope|MessageEncryptor|KeyDerivation|SignatureVerifier|KeyStorage|ChatErrorTests|ErrorRecoveryTests|CustomAmountTests/"
    - name: Run tests (batch 2 — unit + PSK data)
      run: >-
        swift test -v
        --filter "MessageCodableTests|MessageDirectionTests|MessageEqualityTests|PendingMessageTests|SendQueueTests|InMemorySendQueueStorageTests|FileSendQueueStorageTests|SyncManager|PSKEnvelopeTests|PSKExchangeURITests|PSKStateTests"
