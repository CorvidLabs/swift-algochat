name: macOS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  macOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: swift build -v
    # Run tests in small batches — max 2-3 crypto-heavy suites per batch.
    # Swift Testing runs all matched suites concurrently; BoringSSL/CryptoKit
    # crashes (signal 5) when too many Curve25519 operations run in parallel.
    #
    # ForwardSecrecyProof is excluded — it crashes in CI even when run alone
    # (signal 5 at proof4_authenticationDetectsTampering). It's a demonstration
    # suite, not a regression test.
    - name: Run tests (encryptor + key derivation)
      run: >-
        swift test -v
        --filter "MessageEncryptorTests|KeyDerivationTests"
    - name: Run tests (signatures + ephemeral keys)
      run: >-
        swift test -v
        --filter "SignatureVerifierTests|EphemeralKeyManagerTests"
    - name: Run tests (encryption + edge cases)
      run: >-
        swift test -v
        --filter "EncryptionTests|EdgeCaseTests"
    - name: Run tests (key storage)
      run: >-
        swift test -v
        --filter "KeyStorageTests|FileKeyStorageTests"
    - name: Run tests (PSK encryption)
      run: >-
        swift test -v
        --filter "PSKEncryptionTests|PSKRatchetTests"
    - name: Run tests (cross-protocol + decoders)
      run: >-
        swift test -v
        --filter "CrossProtocolTests|EnvelopeDecoderTests"
    - name: Run tests (error handling + validation)
      run: >-
        swift test -v
        --filter "ErrorRecoveryTests|ChatEnvelopeValidationTests"
    - name: Run tests (unit + misc)
      run: >-
        swift test -v
        --filter "ChatEnvelopeTests/|ChatEnvelopeForwardSecrecyTests|ChatErrorTests|PSKEnvelopeTests|MessageCodableTests|MessageDirectionTests|MessageEqualityTests|FileSendQueueStorageTests|ConversationMergeTests|CustomAmountTests|InMemorySendQueueStorageTests|InMemoryMessageCacheTests|PendingMessageTests|SendQueueTests|PSKExchangeURITests|PSKStateTests|PublicKeyCacheTests|ReplyContextTests|ReplyContextModelTests|SyncManagerTests|SyncManagerStorageTests|SyncManagerEdgeCaseTests|KeyStorageErrorTests|FileKeyStorageErrorTests"
